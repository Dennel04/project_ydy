{% extends "base.html" %}
{% load static %}

{% block css %}
    <link rel="stylesheet" href="{% static 'posts/create_post.css' %}">
{% endblock css %}

{% block title %}Create Post | IT Blog{% endblock title %}

{% block body %}
<div class="create-post-container">
    <div class="create-post-header">
        <h1>Create New Post</h1>
        <p class="post-subtitle">Share your ideas with the community</p>
    </div>
    
    <div class="create-post-form">
        {% if error %}
            <p class="error">{{ error }}</p>
        {% endif %}
        
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            
            <div class="form-group">
                <label for="title">Title</label>
                <input type="text" id="title" name="title" class="form-input" placeholder="Enter a descriptive title..." required>
            </div>
            
            <div class="form-group">
                <label for="content">Content</label>
                <textarea id="content" name="content" class="form-textarea" placeholder="Write your post here..." rows="10" required></textarea>
            </div>
            
            <div class="form-group">
                <label for="main_image">Main Image (optional)</label>
                <div class="file-input-container">
                    <input type="file" id="main_image" name="main_image" class="file-input" accept="image/*">
                    <label for="main_image" class="file-input-label">
                        <span class="file-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                <polyline points="21 15 16 10 5 21"></polyline>
                            </svg>
                        </span>
                        <span class="file-text">Choose main image</span>
                    </label>
                    <span id="main-image-name" class="file-name">No image selected</span>
                </div>
            </div>

            <div class="form-group">
                <label for="additional_images">Additional Images (optional)</label>
                <div class="file-input-container">
                    <input type="file" id="additional_images" name="contentImages" class="file-input" accept="image/*" multiple>
                    <label for="additional_images" class="file-input-label">
                        <span class="file-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                <polyline points="21 15 16 10 5 21"></polyline>
                            </svg>
                        </span>
                        <span class="file-text">Add more images</span>
                    </label>
                    <span id="additional-images-names" class="file-name">No additional images selected</span>
                </div>
            </div>
            
            <div class="form-group">
                <label for="tags">Tags (select up to 3, optional)</label>
                <div class="tags-container" id="tags-container">
                    <!-- Теги будут загружены динамически -->
                </div>
                <input type="hidden" id="tags" name="tags" value="">
            </div>

            <script>
                // Загрузка тегов из API
                async function loadTags() {
                    try {
                        const response = await fetch('https://blog-api-wpbz.onrender.com/api/tags');
                        const tags = await response.json();
                        const tagsContainer = document.getElementById('tags-container');
                        tagsContainer.innerHTML = ''; // Очищаем контейнер
                        tags.forEach(tag => {
                            const tagElement = document.createElement('div');
                            tagElement.classList.add('tag');
                            tagElement.dataset.tag = tag.name; // Используем имя тега
                            tagElement.textContent = tag.name;
                            tagsContainer.appendChild(tagElement);
                        });
                    } catch (error) {
                        console.error('Error loading tags:', error);
                        alert('Failed to load tags. Please try again later.');
                    }
                }

                // Вызываем загрузку тегов при загрузке страницы
                document.addEventListener('DOMContentLoaded', loadTags);

                // Handle main image selection
                const mainImageInput = document.getElementById('main_image');
                mainImageInput.addEventListener('change', function() {
                    const fileName = this.files[0]?.name || 'No image selected';
                    document.getElementById('main-image-name').textContent = fileName;
                });

                // Handle additional images selection
                const additionalImagesInput = document.getElementById('additional_images');
                additionalImagesInput.addEventListener('change', function() {
                    const files = this.files;
                    const names = files.length > 0 
                        ? Array.from(files).map(file => file.name).join(', ')
                        : 'No additional images selected';
                    document.getElementById('additional-images-names').textContent = names;
                });

                // Handle tag selection
                const tagsContainer = document.querySelector('.tags-container');
                const tagsInput = document.getElementById('tags');
                let selectedTags = [];

                tagsContainer.addEventListener('click', function(e) {
                    if (e.target.classList.contains('tag')) {
                        const tag = e.target.dataset.tag;
                        
                        if (selectedTags.includes(tag)) {
                            selectedTags = selectedTags.filter(t => t !== tag);
                            e.target.classList.remove('active');
                        } else if (selectedTags.length < 3) {
                            selectedTags.push(tag);
                            e.target.classList.add('active');
                        } else {
                            alert('You can select up to 3 tags only.');
                        }
                        
                        tagsInput.value = selectedTags.join(',');
                    }
                });
            </script>
            
            <div class="form-actions">
                <button type="submit" class="btn-create-post">Create Post</button>
            </div>
        </form>
    </div>
</div>

<script>
    // Handle main image selection
    const mainImageInput = document.getElementById('main_image');
    mainImageInput.addEventListener('change', function() {
        const fileName = this.files[0]?.name || 'No image selected';
        document.getElementById('main-image-name').textContent = fileName;
    });

    // Handle additional images selection
    const additionalImagesInput = document.getElementById('additional_images');
    additionalImagesInput.addEventListener('change', function() {
        const files = this.files;
        const names = files.length > 0 
            ? Array.from(files).map(file => file.name).join(', ')
            : 'No additional images selected';
        document.getElementById('additional-images-names').textContent = names;
    });

    // Handle tag selection
    const tagsContainer = document.querySelector('.tags-container');
    const tagsInput = document.getElementById('tags');
    let selectedTags = [];

    tagsContainer.addEventListener('click', function(e) {
        if (e.target.classList.contains('tag')) {
            const tag = e.target.dataset.tag;
            
            if (selectedTags.includes(tag)) {
                selectedTags = selectedTags.filter(t => t !== tag);
                e.target.classList.remove('active');
            } else if (selectedTags.length < 3) {
                selectedTags.push(tag);
                e.target.classList.add('active');
            }
            
            tagsInput.value = selectedTags.join(',');
        }
    });
</script>
{% endblock body %}