# Блог API

REST API для блог-платформы на Node.js, Express и MongoDB.

## Содержание

- [Установка](#установка)
- [Конфигурация](#конфигурация)
- [Запуск](#запуск)
- [Локальное тестирование](#локальное-тестирование)
- [API Endpoints](#api-endpoints)
  - [Аутентификация](#аутентификация)
  - [Пользователи](#пользователи)
  - [Посты](#посты)
  - [Комментарии](#комментарии)
  - [Теги](#теги)
- [Хранилище изображений](#хранилище-изображений)
- [Google OAuth](#google-oauth)
- [Деплой](#деплой)
- [Безопасность](#безопасность)
- [Работа с изображениями в постах](#работа-с-изображениями-в-постах)

## Установка

```bash
# Клонирование репозитория
git clone [url-репозитория]
cd Blog/Backend

# Установка зависимостей
npm install
```

## Конфигурация

Создайте файл `.env` в корневой директории проекта со следующими переменными:

```env
# Порт сервера (по умолчанию 5000)
PORT=5000

# URI подключения к MongoDB
MONGO_URI=mongodb://localhost:27017/blog_db

# Секретный ключ для JWT
JWT_SECRET=your_jwt_secret_key

# Секретный ключ для CSRF защиты
CSRF_SECRET=your_csrf_secret_key

# Данные для отправки email
GMAIL_USER=your_email@gmail.com
GMAIL_PASS=your_app_password

# Настройки Cloudinary для хранения изображений
CLOUDINARY_CLOUD_NAME=your_cloud_name
CLOUDINARY_API_KEY=your_api_key
CLOUDINARY_API_SECRET=your_api_secret

# Google OAuth (необязательно)
GOOGLE_CLIENT_ID=your_google_client_id
GOOGLE_CLIENT_SECRET=your_google_client_secret
FRONTEND_URL=http://localhost:3000
```

## Запуск

```bash
# Инициализация предопределенных тегов
npm run seed-tags

# Миграция данных изображений в существующих постах
npm run migrate-posts


# Миграция данных изображений в существующих постах
npm run migrate-posts

# Запуск в режиме разработки
npm run dev

# Запуск в production режиме
npm start
```

## Локальное тестирование

Проект включает простой тестовый клиент для локального тестирования API.

### Использование тестового клиента

1. Откройте файл `TestClient/index.html` в браузере
2. Введите URL вашего API: `http://localhost:5000/api` (или URL удаленного API)
3. Нажмите кнопку "Обновить URL"
4. Используйте интерфейс для тестирования различных API-эндпоинтов

### Решение проблем с CORS

Если вы получаете ошибки CORS при локальном тестировании:

1. В режиме разработки API автоматически разрешает запросы с локальных доменов
2. Если у вас все еще возникают проблемы, попробуйте запустить тестовый клиент через простой HTTP-сервер:
   ```bash
   # Установка простого HTTP сервера
   npm install -g http-server
   
   # Запуск в папке TestClient
   cd TestClient
   http-server -p 8080
   ```
   Затем откройте http://localhost:8080 в браузере

3. Для фронтенд-разработки рекомендуется настроить прокси в package.json:
   ```json
   "proxy": "http://localhost:5000"
   ```

## API Endpoints

### Аутентификация

| Метод | Endpoint | Описание |
|-------|----------|----------|
| POST | `/api/auth/register` | Регистрация нового пользователя |
| POST | `/api/auth/login` | Авторизация пользователя |
| GET | `/api/auth/verify-email` | Подтверждение email |
| POST | `/api/auth/resend-verification` | Повторная отправка письма с подтверждением |
| POST | `/api/auth/refresh-token` | Обновление токена |
| GET | `/api/auth/google` | Авторизация через Google |
| GET | `/api/auth/google/callback` | Callback для Google OAuth |
| GET | `/api/csrf-token` | Получение CSRF-токена |

### Пользователи

| Метод | Endpoint | Описание |
|-------|----------|----------|
| GET | `/api/users/profile` | Получение профиля текущего пользователя |
| GET | `/api/users/:id` | Получение публичного профиля пользователя |
| PUT | `/api/users/profile` | Обновление профиля |
| PUT | `/api/users/change-password` | Смена пароля |
| PUT | `/api/users/change-email` | Смена email |
| POST | `/api/users/upload-avatar` | Загрузка аватара |
| DELETE | `/api/users/remove-avatar` | Удаление аватара |
| GET | `/api/users/auth-type` | Проверка типа аутентификации (email/Google) |

### Посты

| Метод | Endpoint | Описание |
|-------|----------|----------|
| GET | `/api/posts` | Получение всех постов |
| GET | `/api/posts/:id` | Получение поста по ID |
| GET | `/api/posts/user/:userId` | Получение всех постов пользователя |
| GET | `/api/posts/search` | Поиск и фильтрация постов |
| POST | `/api/posts` | Создание нового поста |
| PUT | `/api/posts/:id` | Редактирование поста |
| DELETE | `/api/posts/:id` | Удаление поста |
| POST | `/api/posts/like/:id` | Поставить/убрать лайк |
| GET | `/api/posts/isliked/:id` | Проверить, поставлен ли лайк |
| POST | `/api/posts/favourite/:id` | Добавить/убрать из избранного |
| GET | `/api/posts/isfavourite/:id` | Проверить, в избранном ли пост |
| GET | `/api/posts/favourites` | Получить все избранные посты |
| POST | `/api/posts/upload-main-image/:id` | Загрузка главного изображения поста |
| POST | `/api/posts/upload-content-image/:id` | Загрузка изображения в контент поста |
| DELETE | `/api/posts/delete-main-image/:id` | Удаление главного изображения |
| DELETE | `/api/posts/delete-content-image/:id` | Удаление изображения из контента поста |
| POST | `/api/posts/upload-main-image/:id` | Загрузка главного изображения поста |
| POST | `/api/posts/upload-content-image/:id` | Загрузка изображения в контент поста |
| DELETE | `/api/posts/delete-main-image/:id` | Удаление главного изображения |
| DELETE | `/api/posts/delete-content-image/:id` | Удаление изображения из контента поста |

| GET | `/api/posts/bytag/:tagId` | Получение постов по тегу |

### Комментарии

| Метод | Endpoint | Описание |
|-------|----------|----------|
| POST | `/api/comments/:postId` | Создание комментария к посту |
| GET | `/api/comments/:postId` | Получение всех комментариев к посту |
| GET | `/api/comments/comment/:id` | Получение комментария по ID |
| DELETE | `/api/comments/:id` | Удаление комментария |
| POST | `/api/comments/like/:id` | Поставить/убрать лайк комментарию |
| GET | `/api/comments/isliked/:id` | Проверить, поставлен ли лайк комментарию |

### Теги

| Метод | Endpoint | Описание |
|-------|----------|----------|
| GET | `/api/tags` | Получение всех тегов |
| GET | `/api/tags/:id` | Получение тега по ID |
| GET | `/api/tags/slug/:slug` | Получение тега по URL-имени (slug) |
| POST | `/api/tags` | Создание нового тега (только для администратора) |
| PUT | `/api/tags/:id` | Обновление тега (только для администратора) |
| DELETE | `/api/tags/:id` | Удаление тега (только для администратора) |

## Хранилище изображений

API использует Cloudinary для хранения загружаемых изображений (аватары пользователей и изображения к постам).

### Функциональность

- Автоматическая оптимизация изображений
- Ограничение по размеру (до 5MB для аватаров, до 10MB для изображений к постам)
- Поддержка форматов: jpg, jpeg, png, gif, webp
- Автоматическая конвертация изображений в оптимальный формат
- Автоматическое удаление старых изображений при обновлении
- Разные папки для разных типов изображений: "blog-avatars", "blog-post-images"
- Автоматическое изменение размера изображений для адаптации к различным устройствам
- Автоматическое изменение размера изображений для адаптации к различным устройствам


### Настройка

Для работы с Cloudinary необходимо создать аккаунт на [cloudinary.com](https://cloudinary.com) и получить:
- Cloud Name
- API Key
- API Secret

Эти значения должны быть указаны в файле `.env` как описано в разделе [Конфигурация](#конфигурация).

## Google OAuth

API поддерживает аутентификацию через Google OAuth. Подробная инструкция по настройке находится в файле [README_GOOGLE_AUTH.md](./README_GOOGLE_AUTH.md).

## Деплой

Инструкция по деплою API на Render.com находится в файле [deploy.md](./deploy.md).

## Безопасность

API реализует несколько уровней защиты:

1. **Аутентификация с помощью JWT**
   - Токены хранятся как в localStorage, так и в защищенных HTTP-only куки
   - Механизм обновления токенов

2. **CSRF Защита**
   - Double Submit Cookie Pattern
   - Требуется получение CSRF-токена перед выполнением мутирующих операций (POST, PUT, DELETE)
   - Получение токена: `GET /api/csrf-token`

3. **Ограничение запросов (Rate Limiting)**
   - 100 запросов в 15-минутный период для каждого IP-адреса
   - Защита от брутфорс атак на маршруты авторизации

4. **Безопасные заголовки (Helmet)**
   - Content Security Policy (CSP)
   - XSS Protection
   - Защита от снифинга MIME-типов
   - Strict Transport Security (HSTS)
   - Frameguard для защиты от clickjacking

5. **Безопасность паролей**
   - Хеширование с использованием bcrypt
   - Временная блокировка аккаунта после нескольких неудачных попыток входа
   - Проверка силы пароля

> **Примечание:** В режиме разработки некоторые меры безопасности ослаблены для упрощения тестирования. В продакшн-режиме все защитные механизмы активны. 

## Форматирование ответов API

API автоматически форматирует все ответы для обеспечения совместимости с различными фронтенд-фреймворками:

### MongoDB ID формат

- Стандартный формат MongoDB `_id` автоматически преобразуется в формат `id` (без нижнего подчеркивания)
- Это обеспечивает лучшую совместимость с Django и другими фреймворками

### Форматирование дат

- Даты (createdAt, updatedAt и др.) преобразуются из формата ISO в более читаемый формат:
  ```
  С: "2023-06-15T12:30:45.123Z"
  На: "2023-06-15 12:30:45"
  ```

### Техническая реализация

Форматирование реализовано через:
- Middleware `responseFormatter` который автоматически применяется ко всем ответам API
- Утилиту `formatResponse` для ручного форматирования при необходимости

### Пример ответа API:

До форматирования:
```json
{
  "_id": "64a1e2b3c5d6e7f8g9h0i1j2",
  "name": "Пример поста",
  "author": {
    "_id": "64a1e2b3c5d6e7f8g9h0i1j3",
    "username": "user123"
  },
  "createdAt": "2023-06-15T12:30:45.123Z",
  "updatedAt": "2023-06-16T10:20:30.456Z"
}
```

После форматирования:
```json
{
  "id": "64a1e2b3c5d6e7f8g9h0i1j2",
  "name": "Пример поста",
  "author": {
    "id": "64a1e2b3c5d6e7f8g9h0i1j3",
    "username": "user123"
  },
  "createdAt": "2023-06-15 12:30:45",
  "updatedAt": "2023-06-16 10:20:30"
}
```

## Безопасность API

### Санитизация данных пользователя

Для защиты чувствительных данных используется функция `sanitizeUser`, которая фильтрует приватные и чувствительные поля перед отправкой клиенту:

- **Чувствительные поля** (всегда исключаются):
  - password
  - passwordResetToken
  - passwordResetExpires
  - loginAttempts
  - lockUntil
  - googleId
  - __v

- **Приватные поля** (доступны только самому пользователю):
  - логин
  - email
  - верификация email
  - список постов
  - лайки/избранное
  - даты создания/обновления

- **Публичные поля** (доступны всем):
  - id
  - имя пользователя
  - описание
  - аватар

Режимы работы `sanitizeUser`:
1. `{ publicView: false }` (по умолчанию) - возвращает приватные и публичные поля
2. `{ publicView: true }` - возвращает только публичные поля
3. `{ includeFields: ['field1', 'field2'] }` - добавляет указанные поля

Функция преобразует `_id` в `id` для удобства клиентской стороны и работает с mongoose документами.

### Тестирование

Для проверки функциональности санитизации используется тестовый сценарий `tests/sanitizeUser.test.js`. 

### Подтверждение Email и управление неподтвержденными аккаунтами

API реализует систему подтверждения email для повышения безопасности и борьбы с фиктивными регистрациями:

#### Процесс регистрации с подтверждением

1. Пользователь регистрируется, указывая email
2. На указанный email отправляется письмо с ссылкой для подтверждения
3. При переходе по ссылке аккаунт активируется
4. Неподтвержденные аккаунты не могут войти в систему

#### Автоматическая очистка неподтвержденных аккаунтов

- Неподтвержденные аккаунты имеют срок действия 48 часов
- По истечении этого срока они автоматически удаляются:
  - При попытке регистрации с таким же логином/email
  - При запуске скрипта очистки (`npm run cleanup-users`)

#### Повторная отправка подтверждения

- API поддерживает повторную отправку письма с подтверждением
- Endpoint: `POST /api/auth/resend-verification`
- Требуемые данные: `email` неподтвержденного аккаунта
- При повторной отправке срок действия аккаунта продлевается на 48 часов

#### Настройка регулярной очистки

Для автоматической очистки просроченных аккаунтов на сервере можно настроить cron-задачу:

```bash
# Пример cron-задачи для ежедневной очистки в полночь
0 0 * * * cd /path/to/backend && npm run cleanup-users >> /var/log/cleanup-users.log 2>&1
```

## Работа с изображениями в постах

В блоге реализована поддержка двух типов изображений:

1. **Главное изображение (mainImage)** - отображается вверху поста после заголовка
2. **Изображения контента (images)** - массив изображений, встроенных в текст поста

### API для работы с изображениями


#### Создание поста с изображениями
```
POST /api/posts
```
API поддерживает создание поста с загрузкой изображений в одном запросе через multipart/form-data.

**Параметры:**
- `name` - название поста
- `content` - содержимое поста
- `tags` - массив или строка с ID тегов
- `isPublished` - статус публикации (опционально)
- `mainImage` - файл главного изображения (опционально)
- `contentImages` - файлы изображений для контента (опционально, можно загрузить несколько)

**Пример использования формы:**
```html
<form method="post" enctype="multipart/form-data">
  <input type="text" name="name" value="Название поста">
  <textarea name="content">Содержимое поста</textarea>
  <input type="file" name="mainImage" accept="image/*">
  <input type="file" name="contentImages" accept="image/*" multiple>
  <button type="submit">Создать пост</button>
</form>
```

**Ответ:**
```json
{
  "id": "60d21b4667d0d8992e610c85",
  "name": "Название поста",
  "content": "Содержимое поста...",
  "mainImage": "https://res.cloudinary.com/...",
  "images": ["https://res.cloudinary.com/...", "..."],
  "author": {
    "id": "60d21b4667d0d8992e610c86",
    "username": "user123"
  }
}
```

#### Загрузка главного изображения
```
POST /api/posts/upload-main-image/:id
```

Загружает главное изображение для существующего поста. Если у поста уже есть главное изображение, оно будет заменено.


**Параметры:**
- `:id` - ID поста
- `image` - файл изображения (multipart/form-data)

**Ответ:**
```json
{
  "message": "Главное изображение успешно загружено",
  "imageUrl": "https://res.cloudinary.com/..."
}
```

#### Загрузка изображения для контента
```
POST /api/posts/upload-content-image/:id
```
Загружает изображение и добавляет его в массив изображений поста.

**Параметры:**
- `:id` - ID поста
- `image` - файл изображения (multipart/form-data)

**Ответ:**
```json
{
  "message": "Изображение контента успешно загружено",
  "imageUrl": "https://res.cloudinary.com/..."
}
```

#### Удаление изображения из контента
```
DELETE /api/posts/delete-content-image/:id
```
Удаляет изображение из массива изображений поста.

**Параметры:**
- `:id` - ID поста
- Body:
```json
{
  "imageUrl": "https://res.cloudinary.com/..."
}
```

**Ответ:**
```json
{
  "message": "Изображение успешно удалено",
  "images": ["https://res.cloudinary.com/...", "..."]
}
```

#### Удаление главного изображения
```
DELETE /api/posts/delete-main-image/:id
```
Удаляет главное изображение поста.

**Параметры:**
- `:id` - ID поста

**Ответ:**
```json
{
  "message": "Главное изображение успешно удалено"
}
```

### Использование изображений в посте

При создании или редактировании поста можно указать главное изображение и массив изображений контента:

```json
{
  "name": "Название поста",
  "content": "Содержимое поста... Текст с изображениями...",
  "tags": ["id_tag1", "id_tag2"],
  "mainImage": "https://res.cloudinary.com/...",
  "images": [
    "https://res.cloudinary.com/...",
    "https://res.cloudinary.com/..."
  ]
}
```

**Примечания:**
- Поля `mainImage` и `images` являются опциональными
- Можно создавать чисто текстовые посты без изображений
- Изображения контента должны быть расположены в тексте в том же порядке, в котором они указаны в массиве `images`
- Для создания поста с загрузкой изображений используйте multipart/form-data
- Для обновления существующего поста с изображениями рекомендуется использовать отдельные эндпоинты загрузки 